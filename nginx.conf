# vim:ft=nginx

user nobody;
worker_processes auto;
daemon off;
pid /var/run/nginx.pid;
error_log /var/log/nginx/nginx-error.log warn;

events {
	worker_connections 1024;
}

http {
	default_type application/octet-stream;
	charset utf-8;

	# Don't expose nginx version through headers
	server_tokens off;

	include mime.types;

	# Enables the use of sendfile(2) to copy data in kernel-space
	# instead of using read(2) and write(2) in user space.
	sendfile on;

	# Wait for the packet size to reach the MSS before sending.
	# This leads to increased throughput. tcp_nopush is turned off
	# when the remaining data is less than the MSS
	tcp_nopush on;

	# .. So that tcp_nodelay takes over and the last packet is sent
	# immediately despite not having reached the MSS
	tcp_nodelay on;

	# The number of requests a client can make over a
	# single keepalive connection
	keepalive_requests 128;

	# How long an idle keepalive connection remains open
	keepalive_timeout 65;

	# The time nginx will wait for the client to send the request
	# body after the request is received.
	client_body_timeout 10;

	# The time nginx will wait for the client to send the request
	# header after the request is received
	client_header_timeout 10;

	# The time nginx will wait for the client between
	# read operations
	send_timeout 10;

	# The size of the buffer holding the body-part
	# of the requests received from the client (the POST-data)
	client_body_buffer_size 128k;

	# The max size for a client request (Note: file upload limit)
	client_max_body_size 64m;

	# The size of the buffer holding the headers
	# received from the client.
	client_header_buffer_size 1k;

	# Needs explanation
	large_client_header_buffers	8 10k;
	output_buffers 1 32k;
	postpone_output 1460;
	open_file_cache	max=1000 inactive=20s;
	open_file_cache_valid 30s;
	open_file_cache_min_uses 3;
	open_file_cache_errors off;

	# Enable gzip compression
	gzip on;
	gzip_comp_level 4;
	gzip_min_length 1000;
	gzip_buffers 16 8k;
	gzip_http_version 1.0;
	gzip_proxied any;
	gzip_disable msie6;
	gzip_vary on;
	gzip_types	application/atom+xml
				application/javascript
				application/json
				application/rss+xml
				application/vnd.ms-fontobject
				application/x-font-ttf
				application/x-web-app-manifest+json
				application/xhtml+xml
				application/xml
				font/opentype
				image/svg+xml
				image/x-icon
				text/css
				text/plain
				text/x-component;

	# Extended logging used by nginx-amplify
	log_format main_ext	'$remote_addr - $remote_user [$time_local] "$request" '
						'$status $body_bytes_sent "$http_referer" '
						'"$http_user_agent" "$http_x_forwarded_for" '
						'"$host" sn="$server_name" '
						'rt=$request_time '
						'ua="$upstream_addr" us="$upstream_status" '
						'ut="$upstream_response_time" ul="$upstream_response_length" '
						'cs=$upstream_cache_status';

	# Better logging when nginx acts as a proxy
	log_format proxy	'$remote_addr - $remote_user [$time_local] '
						'"$request" $status $body_bytes_sent '
						'"$http_referer" "$http_user_agent" '
						'X-Forwarded-For=$http_x_forwarded_for Host=$host $request_id';

	# Exposes nginx stats on 127.0.0.1:80/nginx_status
	# Used by nginx-amplify
	server {
		listen 127.0.0.1:80;
		server_name 127.0.0.1;
		location /nginx_status {
			stub_status;
			allow 127.0.0.1;
			deny all;
		}
	}

	# Enable sites by creating symlinks in sites-enabled
	include sites-enabled/*.conf;
}
